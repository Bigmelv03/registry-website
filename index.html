<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Iglesia Buenas Nuevas – Lista de Regalos por Fases</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- [ALL YOUR STYLES, UNCHANGED] -->
  <style>
    /* ...[SNIP]... (keep all your CSS as above) ...[SNIP]... */
    /* Use all your style code exactly as you have it! */
  </style>
</head>
<body>

  <!-- ===== Your static content goes here ===== -->
  <h1>Iglesia Buenas Nuevas - Registro de sistemas de sonido</h1>
  <h2>
    <span style="color:#aac;font-size:1.3em;">Good News Church - Sound System Registry</span>
  </h2>

  <!-- All the "testimony", "heart behind", instructions, notes, QR, etc stays here -->

  <!-- 
    REMOVE ALL <div class="phase-items"></div> from your HTML.
    The script below will generate all phases and item cards automatically!
  -->

  <!-- 
    Just put ONE empty container where you want the full list to go:
  -->
  <div id="dynamic-phases"></div>

  <!-- Only ONE modal image block! -->
  <div class="modal-img-bg" id="imgModal" onclick="this.classList.remove('active')">
    <img id="modalImg" src="">
  </div>

  <!-- =================== SCRIPT STARTS HERE =================== -->
  <<script>
/*** ===== CONFIG ===== ***/
const API_URL = "https://script.google.com/macros/s/AKfycbxTvUMgfiDCpxxtgXBpSaR0JxOAWcqUzXL_mvo6Q-k6Oae9GD5zUC3C9-RAZdKgYpV_yw/exec";

/*** ===== UTIL ===== ***/
const $ = sel => document.querySelector(sel);
function ensureArray(payload){
  // Accept: array OR {items:[...]} OR {data:[...]} OR {result:[...]}
  if (Array.isArray(payload)) return payload;
  if (payload && Array.isArray(payload.items)) return payload.items;
  if (payload && Array.isArray(payload.data))  return payload.data;
  if (payload && Array.isArray(payload.result))return payload.result;
  throw new TypeError("API did not return a list of items.");
}
function el(tag, attrs={}, ...children){
  const node = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs||{})){
    if (k === "class") node.className = v;
    else if (k === "html") node.innerHTML = v;
    else if (k.startsWith("on") && typeof v === "function") node.addEventListener(k.substring(2), v);
    else node.setAttribute(k, v);
  }
  for (const c of children){
    if (c == null) continue;
    node.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
  }
  return node;
}

/*** ===== MODAL (image enlarge) ===== ***/
function ensureModal(){
  if ($("#imgModal")) return;
  const bg = el("div", {class:"modal-img-bg", id:"imgModal"});
  const img = el("img", {id:"modalImg", alt:""});
  bg.appendChild(img);
  document.body.appendChild(bg);
  bg.addEventListener("click", e => { if (e.target === bg) bg.classList.remove("active"); });
}
function enlargeImg(img){
  ensureModal();
  $("#modalImg").src = img.src;
  $("#imgModal").classList.add("active");
}

/*** ===== RENDER ===== ***/
function phaseHeaderNode(n){
  // You already have static intros in your HTML for each phase.
  // This helper returns the correct .phase-items container for a phase,
  // creating it if it doesn't exist.
  let container = document.getElementById(`phase-items-${n}`);
  if (!container){
    // Find the next .phase-items following the Phase N <h2> block, or create one.
    const h2s = Array.from(document.querySelectorAll("h2"));
    const h2 = h2s.find(h => h.textContent.includes(`Fase ${n} `) || h.textContent.trim().startsWith(`Fase ${n}`));
    container = el("div", {class:"phase-items", id:`phase-items-${n}`});
    if (h2){
      // insert after the heading/intros
      // try to place after the next sibling .phase-intro if present
      let insertAfter = h2.nextElementSibling && h2.nextElementSibling.classList.contains("en")
        ? h2.nextElementSibling.nextElementSibling
        : h2.nextElementSibling;
      if (insertAfter && insertAfter.classList.contains("phase-intro")){
        insertAfter.parentNode.insertBefore(container, insertAfter.nextElementSibling);
      } else {
        h2.parentNode.insertBefore(container, h2.nextElementSibling);
      }
    } else {
      // fallback to end of body
      document.body.appendChild(container);
    }
  }
  return container;
}

function statusBadge(purchased, qty){
  purchased = Number(purchased||0); qty = Number(qty||0);
  const wrap = el("div", {style:"font-weight:800;margin:.35em 0;"});
  if (!qty || qty <= 0){
    wrap.appendChild(el("span", {style:"color:#aaa"}, "—"));
    return wrap;
  }
  if (purchased <= 0){
    wrap.appendChild(el("span", {style:"color:#ff6b6b"}, "Comprado 0 de " + qty + " · Purchased 0 of " + qty));
    return wrap;
  }
  if (purchased < qty){
    wrap.appendChild(el("span", {style:"color:#ffd166"}, `Comprado ${purchased} de ${qty} · Purchased ${purchased} of ${qty}`));
    return wrap;
  }
  // complete
  const flash = el("span", {style:"color:#7CFC00;animation:flash .6s linear infinite alternate;display:inline-block;"}, "COMPLETO · COMPLETE");
  wrap.appendChild(flash);
  return wrap;
}

function itemCard(it){
  const {
    phase,                 // number (1..6)
    image,                 // K column URL
    title_es, title_en,    // C,D
    desc_es,  desc_en,     // E,F
    price,                 // G
    purchased,             // H
    quantity               // I
  } = it;

  const img = el("img", {src:image||"", alt:title_en||title_es||"Item image", onclick: () => enlargeImg(img)});
  const title = el("div", {class:"item-title", html:`
    ${title_es ? title_es : ""}<br>
    <span style="font-size:.95em;color:#aac;">${title_en ? "("+title_en+")" : ""}</span>
  `});
  const qty = el("div", {class:"qty"}, `Cantidad / Quantity: ${quantity ?? ""}`);
  const priceNode = el("div", {class:"price"}, price ? String(price) : "");
  const desc = el("div", {class:"desc", html:`
    ${desc_es ? desc_es : ""}<br><br>
    ${desc_en ? desc_en : ""}
  `});

  const badge = statusBadge(purchased, quantity);

  const card = el("div", {class:"item"},
    // small instruction above picture
    el("div", {class:"small", style:"margin-bottom:.35em;color:#ffe53b;text-align:center;"}, 
       "Toca la imagen para ampliarla · Tap image to enlarge"),
    img,
    badge,
    title,
    qty,
    priceNode,
    desc
  );

  return {phase, card};
}

/*** ===== LOAD ===== ***/
async function loadList(){
  ensureModal();

  // show a tiny “loading…” under the main title
  const title = document.querySelector("h1");
  const hint = el("div", {id:"load-hint", style:"color:#aaa;margin:.3em 0 1.2em 0;"},"Loading registry… / Cargando lista…");
  title && title.insertAdjacentElement("afterend", hint);

  let payload;
  try{
    const res = await fetch(API_URL, {method:"GET"});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    // Some GAS web apps return text/plain; parse defensively
    const text = await res.text();
    try { payload = JSON.parse(text); }
    catch { throw new Error("API did not return valid JSON."); }
    const items = ensureArray(payload);
    // Optional: handle top message if your API includes it
    if (payload && (payload.message || payload.banner)){
      const msg = String(payload.message || payload.banner || "").trim();
      if (msg){
        const box = el("div", {class:"note", id:"top-message"}, msg);
        document.body.insertBefore(box, document.body.firstElementChild.nextSibling);
      }
    }
    // Render items grouped by phase
    const cards = items
      .filter(x => x && x.phase != null)
      .map(itemCard);

    // inject into phase containers
    for (const {phase, card} of cards){
      const container = phaseHeaderNode(phase);
      container && container.appendChild(card);
    }

    // done
    hint && hint.remove();
  }catch(err){
    console.error(err);
    const errBox = el("div", {style:"color:#f66;font-size:1.05em;margin-top:1em;text-align:center;"},
      "Error loading the registry list. Please try again later.",
      el("div", {style:"margin-top:.35em;color:#f88;font-size:.92em;"},
        err && err.message ? ("TypeError: " + err.message) : "")
    );
    title && title.insertAdjacentElement("afterend", errBox);
    hint && hint.remove();
  }
}

document.addEventListener("DOMContentLoaded", loadList);
</script>

<!-- Image Modal (keep this once in your HTML) -->
<div class="modal-img-bg" id="imgModal"><img id="modalImg" src=""></div>
