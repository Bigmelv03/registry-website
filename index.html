<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Iglesia Buenas Nuevas – Lista de Regalos por Fases</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- [ALL YOUR STYLES, UNCHANGED] -->
  <style>
    /* ...[SNIP]... (keep all your CSS as above) ...[SNIP]... */
    /* Use all your style code exactly as you have it! */
  </style>
</head>
<body>

  <!-- ===== Your static content goes here ===== -->
  <h1>Iglesia Buenas Nuevas - Registro de sistemas de sonido</h1>
  <h2>
    <span style="color:#aac;font-size:1.3em;">Good News Church - Sound System Registry</span>
  </h2>

  <!-- All the "testimony", "heart behind", instructions, notes, QR, etc stays here -->

  <!-- 
    REMOVE ALL <div class="phase-items"></div> from your HTML.
    The script below will generate all phases and item cards automatically!
  -->

  <!-- 
    Just put ONE empty container where you want the full list to go:
  -->
  <div id="dynamic-phases"></div>

  <!-- Only ONE modal image block! -->
  <div class="modal-img-bg" id="imgModal" onclick="this.classList.remove('active')">
    <img id="modalImg" src="">
  </div>

  <!-- =================== SCRIPT STARTS HERE =================== -->
  <script>
/*** ===== CONFIG ===== ***/
const API_URL = "https://script.google.com/macros/s/AKfycbxTvUMgfiDCpxxtgXBpSaR0JxOAWcqUzXL_mvo6Q-k6Oae9GD5zUC3C9-RAZdKgYpV_yw/exec";

/*** ===== SMALL HELPERS ===== ***/
const $ = s => document.querySelector(s);
function el(tag, attrs={}, ...children){
  const n = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs||{})){
    if (k === "class") n.className = v;
    else if (k === "html") n.innerHTML = v;
    else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.substring(2), v);
    else n.setAttribute(k, v);
  }
  for (const c of children) if (c!=null) n.appendChild(typeof c==="string"?document.createTextNode(c):c);
  return n;
}
function normKey(s){
  return String(s||"").toLowerCase()
    .replace(/\(.*?\)/g,"")   // drop (ES)/(EN) etc
    .replace(/[^a-z0-9]+/g,""); // remove spaces/punct
}
function pick(obj, candidates){
  // return first non-empty value matching any candidate keyword
  const keys = Object.keys(obj||{});
  for (const k of keys){
    const nk = normKey(k);
    for (const want of candidates){
      if (nk === want) return obj[k];
    }
  }
  return undefined;
}
function ensureModal(){
  if ($("#imgModal")) return;
  const bg = el("div", {class:"modal-img-bg", id:"imgModal"});
  const img = el("img", {id:"modalImg", alt:""});
  bg.appendChild(img);
  document.body.appendChild(bg);
  bg.addEventListener("click", e => { if (e.target === bg) bg.classList.remove("active"); });
}
function enlargeImg(img){
  ensureModal();
  $("#modalImg").src = img.src;
  $("#imgModal").classList.add("active");
}

/*** ===== PAYLOAD NORMALIZATION ===== ***/
function arrayRowsToObjects(rows){
  if (!Array.isArray(rows) || rows.length === 0) return [];
  const headers = rows[0];
  const body = rows.slice(1);
  return body.map(r => {
    const o = {};
    headers.forEach((h,i)=>{ o[h||("Column"+(i+1))] = r[i]; });
    return o;
  });
}
function normalizeItems(payload){
  // Accept: array, {items}, {data}, {result}, {rows}, etc.
  let raw = Array.isArray(payload) ? payload
          : Array.isArray(payload?.items) ? payload.items
          : Array.isArray(payload?.data)  ? payload.data
          : Array.isArray(payload?.result)? payload.result
          : Array.isArray(payload?.rows)  ? payload.rows
          : null;
  if (!raw) throw new TypeError("API did not return a list.");

  // If it's an array of arrays, map using first row as headers
  if (Array.isArray(raw[0]) && !Array.isArray(raw[0][0]) && typeof raw[0][0] !== "object"){
    raw = arrayRowsToObjects(raw);
  }

  // Now raw is an array of objects (keys could be “Column2” or nice names)
  return raw.map(obj => {
    // prefer named headers, but accept ColumnN too
    const normObj = {};
    for (const [k,v] of Object.entries(obj)){
      normObj[k] = typeof v === "string" ? v.trim() : v;
    }

    const phase      = Number(pick(normObj, ["phase"]));
    const title_es   = pick(normObj, ["titlees","titlespanish","tituloes","titulo"]);
    const title_en   = pick(normObj, ["titleen","titleenglish"]);
    const desc_es    = pick(normObj, ["descripciones","desces","descripcion","descriptiones"]);
    const desc_en    = pick(normObj, ["descriptionen","descen","description"]);
    const price      = pick(normObj, ["price","precio"]);
    const purchased  = Number(pick(normObj, ["purchased","comprado","purchases"]));
    const quantity   = Number(pick(normObj, ["quantity","cantidad","qty"]));
    const image      = pick(normObj, ["imagelink","imageurl","image","imagen"]);

    return { phase, title_es, title_en, desc_es, desc_en, price, purchased, quantity, image };
  }).filter(x => x.phase); // keep rows that have a phase
}

/*** ===== RENDER ===== ***/
function phaseContainer(phaseNum){
  let c = document.getElementById(`phase-items-${phaseNum}`);
  if (c) return c;

  // try to find the Fase N heading and insert after its intro
  const h2s = Array.from(document.querySelectorAll("h2"));
  const h2 = h2s.find(h => /Fase\s*([1-6])/.test(h.textContent) && Number(h.textContent.match(/Fase\s*([1-6])/)[1]) === Number(phaseNum));
  c = el("div", {class:"phase-items", id:`phase-items-${phaseNum}`});
  if (h2){
    // insert after the next .phase-intro if present
    let sib = h2.nextElementSibling;
    if (sib && sib.classList.contains("en")) sib = sib.nextElementSibling;
    if (sib && sib.classList.contains("phase-intro")){
      sib.parentNode.insertBefore(c, sib.nextElementSibling);
    } else {
      h2.parentNode.insertBefore(c, h2.nextElementSibling);
    }
  } else {
    document.body.appendChild(c);
  }
  return c;
}
function statusBadge(purchased, qty){
  purchased = Number(purchased||0);
  qty = Number(qty||0);
  const wrap = el("div", {style:"font-weight:800;margin:.35em 0;"});
  if (!qty){
    wrap.appendChild(el("span", {style:"color:#aaa"},"—"));
  } else if (purchased <= 0){
    wrap.appendChild(el("span", {style:"color:#ff6b6b"}, `Comprado 0 de ${qty} · Purchased 0 of ${qty}`));
  } else if (purchased < qty){
    wrap.appendChild(el("span", {style:"color:#ffd166"}, `Comprado ${purchased} de ${qty} · Purchased ${purchased} of ${qty}`));
  } else {
    wrap.appendChild(el("span", {style:"color:#7CFC00;animation:flash .6s linear infinite alternate;display:inline-block;"}, "COMPLETO · COMPLETE"));
  }
  return wrap;
}
function cardFor(item){
  const imgEl = el("img", {
    src: item.image || "",
    alt: (item.title_en || item.title_es || "Item"),
    onclick: () => enlargeImg(imgEl)
  });
  const title = el("div", {class:"item-title", html:`
    ${item.title_es || ""}<br>
    <span style="font-size:.95em;color:#aac;">${item.title_en ? "("+item.title_en+")" : ""}</span>
  `});
  const qty  = el("div",{class:"qty"}, `Cantidad / Quantity: ${item.quantity ?? ""}`);
  const price= el("div",{class:"price"}, item.price ? String(item.price) : "");
  const desc = el("div",{class:"desc", html:`
    ${item.desc_es || ""}<br><br>${item.desc_en || ""}
  `});
  const badge= statusBadge(item.purchased, item.quantity);

  return el("div", {class:"item"},
    el("div",{class:"small",style:"margin-bottom:.35em;color:#ffe53b;text-align:center;"},
       "Toca la imagen para ampliarla · Tap image to enlarge"),
    imgEl, badge, title, qty, price, desc
  );
}

/*** ===== MAIN LOAD ===== ***/
async function loadList(){
  ensureModal();
  const title = document.querySelector("h1");
  const hint = el("div",{id:"load-hint",style:"color:#aaa;margin:.3em 0 1.2em 0;"},"Loading registry… / Cargando lista…");
  title && title.insertAdjacentElement("afterend", hint);

  try{
    const res = await fetch(API_URL, {method:"GET"});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    let json; try { json = JSON.parse(text); } catch(e){ throw new Error("Invalid JSON from API."); }

    const items = normalizeItems(json);

    // (Optional) show top message if present
    const msg = (json.message || json.banner || "").trim?.() || "";
    if (msg) document.body.insertBefore(el("div",{class:"note",id:"top-message"}, msg), document.body.children[1]);

    // render
    items.sort((a,b)=> (a.phase||0)-(b.phase||0));
    for (const it of items){
      phaseContainer(it.phase).appendChild(cardFor(it));
    }
  }catch(err){
    console.error(err);
    const errBox = el("div", {style:"color:#f66;font-size:1.05em;margin-top:1em;text-align:center;"},
      "Error loading the registry list. Please try again later.",
      el("div", {style:"margin-top:.35em;color:#f88;font-size:.92em;"}, String(err && err.message ? err.message : "")));
    title && title.insertAdjacentElement("afterend", errBox);
  }finally{
    hint && hint.remove();
  }
}

document.addEventListener("DOMContentLoaded", loadList);
</script>

<!-- Image Modal (keep this once in your HTML) -->
<div class="modal-img-bg" id="imgModal"><img id="modalImg" src=""></div>
